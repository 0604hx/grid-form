<template>
    <div>
        <n-dialog-provider>
            <n-message-provider>
                <n-layout style="height: 100%">
                    <n-layout-header :style="{height: headerHeight+'px', padding: '10px'}" bordered>
                        <n-space justify="space-between">
                            <slot name="title">
                                <div style="font-size: 24px;">GRID-FORM Ë°®ÂçïËÆæËÆ°Âô® <template v-if="form.id">#{{form.id}}</template> </div>
                            </slot>

                            <n-space size="small">
                                <!-- <n-button type="primary" secondary @click="toPreview"><template #icon><n-icon :component="Eye" /></template> È¢ÑËßà</n-button> -->
                                <n-dropdown trigger="click" :options="cogOptions" :show-arrow="true" @select="onFuncSelect">
                                    <n-button type="primary" secondary><template #icon><n-icon :component="Cog" /></template></n-button>
                                </n-dropdown>

                                <n-button type="primary" @click="toSave" :loading="loading"><template #icon><n-icon :component="CheckCircle" /></template> ‰øùÂ≠òË°®Âçï</n-button>
                            </n-space>
                        </n-space>
                    </n-layout-header>

                    <n-layout position="absolute" :style="{top: headerHeight + 'px', bottom: showFooter?(footerHeight + 'px'):'0px'}" has-sider>
                        <!--Â∑¶‰æßË°®ÂçïÈÖçÁΩÆÈù¢Êùø-->
                        <n-layout-sider collapse-mode="transform" :collapsed-width="collapsedWidth" :width="siderWidth" show-trigger="arrow-circle" content-style="padding: 12px;" :native-scrollbar="false" bordered>
                            <FormSetting :form="form" :compact="compact" />
                        </n-layout-sider>

                        <!--ËÆæËÆ°Âô®‰∏ª‰Ωì-->
                        <n-layout  has-sider sider-placement="right">
                            <n-layout :native-scrollbar="false" content-style="padding: 10px 20px 10px 20px;">
                                <n-form :label-width="form.labelWidth" :size="form.size" :label-placement="form.labelPlacement" :label-align="form.labelAlign">
                                    <Container :form="form" :gridGap="gridGap" :contextMenu="menu" :bindClick="toActice"
                                        :renders="renders" :components="components" top
                                        :track="debug?track:null" />

                                    <div style="text-align: center; margin-top: 12px;">
                                        <n-space justify="center">
                                            <n-button v-if="form.submitText" size="large" type="primary" @click="toTestSubmit">{{form.submitText}}</n-button>
                                            <n-button v-for="btn in form.buttons" :type="btn.theme" size="large">{{btn.text}}</n-button>
                                        </n-space>
                                        <div v-if="form.submitText" style="margin-top: 6px;"> <n-text depth="3">ÁÇπÂáªÊåâÈíÆÊºîÁ§∫Êèê‰∫§ÂêéÂõûÊòæÊñáÊ°à</n-text> </div>
                                    </div>
                                </n-form>
                            </n-layout>

                            <!--Âè≥‰æßÁªÑ‰ª∂Â±ûÊÄßÈù¢Êùø-->
                            <n-layout-sider collapse-mode="transform" :collapsed-width="collapsedWidth" show-trigger="arrow-circle" content-style="padding: 12px;" :native-scrollbar="false" :width="siderWidth" bordered>
                                <AttributeEditor :bean="attrEditor.bean" :items="attrEditor.items" :compact="compact" />
                            </n-layout-sider>
                        </n-layout>
                    </n-layout>

                    <n-layout-footer v-if="showFooter" position="absolute" :style="{height: footerHeight+'px', padding: '10px'}" bordered>
                        <slot name="footer">
                            <div style="text-align:center">
                                üòä ÊÑüË∞¢‰ΩøÁî® <n-button size="small" text tag="a" target="_blank" href="https://github.com/0604hx/grid-form">GRID-FORM</n-button> Ë°®ÂçïËÆæËÆ°Âô® üòä
                            </div>
                        </slot>
                    </n-layout-footer>
                </n-layout>
            </n-message-provider>
        </n-dialog-provider>

        <!--Âè≥ÈîÆËèúÂçï-->
        <ContextMenu v-if="contextMenu" :components="components" ref="menu" @select="onMenuSelect" />

        <n-modal v-model:show="importForm.show" preset="card" :style="{width: '1000px'}" :mask-closable="false" title="ÂØºÂÖ•Ë°®Âçï">
            <CodeEditor v-model:value="importForm.code" height="calc(100vh - 180px)" style="margin-top: 8px;"/>
            <n-space style="margin-top: 10px;" justify="center">
                <n-button type="primary" @click="toImport">Êõ¥Êñ∞ JSON Êï∞ÊçÆÂà∞ËÆæËÆ°Âô®</n-button>
            </n-space>
        </n-modal>
    </div>
</template>

<script setup>
    import { ref, onMounted,onUnmounted, h, reactive, toRaw, unref, nextTick } from 'vue'
    import { Bolt, Plus, CheckCircle, Download, FileDownload, Copy, HandPointLeftRegular,HandPointRightRegular, Eye, Cog, Code, Upload } from "@vicons/fa"
    import { useMessage, useDialog, NIcon, NMessageProvider, NDialogProvider, NLayout, NDropdown, NButton, NLayoutHeader, NLayoutFooter, NLayoutSider, NSpace, NForm, NText, NModal } from "naive-ui"

    import { createFormItem, buildOptions, buildComponent, withHtmlNode, copyText, triggerLoaded, extendFormItems } from '@grid-form/common'

    import Selector from "./components/selector.vue"
    import AttributeEditor from "./form-attribute.vue"
    import FormSetting from "./form-setting.vue"
    import ContextMenu from "./components/context-menu.vue"
    import Container from "./container.vue"
    import CodeEditor from "./components/editor.code.vue"

    const message = useMessage()
    const dialog = useDialog()

    const emits = defineEmits(['save'])
    const props = defineProps({
        siderWidth:{type:[Number, String], default: 360 },      //Â∑¶Âè≥‰∏§‰∏™‰æßËæπÊ†èÁöÑÂÆΩÂ∫¶ÔºåÊîØÊåÅ px„ÄÅ% Âçï‰ΩçÔºåÂª∫ËÆÆÁõ¥Êé•‰º†ÈÄíÊï∞ÂÄº
        gridGap: {type:Number, default: 10},                    //Ê†ÖÊ†èÈó¥ÈöîÔºåÂçï‰Ωç px
        loading: {type:Boolean},
        review: {type:Boolean, default: false},                 //ÊòØÂê¶ÂÅöË°®ÂçïÈ°πÊ£ÄÈ™å
        renders:{type:Object},                                  //ÂÖ∑‰ΩìÁöÑÁªÑ‰ª∂Ê∏≤ÊüìÂáΩÊï∞
        components:{type:Array, default:[]},                    //ÂèØÈÄâÁöÑÁªÑ‰ª∂
        form: {type:Object},
        compact:{type:Boolean, default: false},                 //Á¥ßÂáëÁöÑÂ∏ÉÂ±ÄÔºåÂ¶ÇÊûúËÆæÁΩÆ‰∏∫trueÔºåÂàôÂ∑¶Âè≥‰∏§‰æßÁöÑÂ±ûÊÄßÁºñËæëË°åË∑ùÁº©Áü≠
        headerHeight: { type:Number, default: 55 },
        debug: {type:Boolean, default: false},                  //ÂºÄÂêØdebug Ê®°ÂºèÂêéÔºå‰ºöÂú®ÊéßÂà∂Âè∞ËæìÂÖ•ÂêÑÁßç‰ø°ÊÅØ
        showFooter: {type:Boolean, default: false},
        footerHeight: {type:Number, default: 50 },
        contextMenu: {type:Boolean, default: false},            //ÂºÄÂêØÂè≥ÈîÆËèúÂçï
        enableCtrlS: {type:Boolean, default: false},            //ÊòØÂê¶ÂºÄÂêØ CTRL+S ‰øùÂ≠òÂø´Êç∑ÈîÆ
    })

    const track = (...ps)=> console.debug("%c[GRID-FORM DESIGNER]", "background:#8c0776;padding:3px;color:white", ...ps)

    const collapsedWidth = 10
    const cogOptions = [
        { label:"ÁºñËæëJSONÊï∞ÊçÆ", key:"edit", icon:()=> h(NIcon, null, ()=> h(Code)) },
        { label:"ÂØºÂÖ•JSONË°®Âçï", key:"import", icon:()=> h(NIcon, null, ()=> h(Upload)) },
        { type:"divider"},
        { label:"ÂØºÂá∫ÔºàÂçïË°åJSONÔºâ", key:"oneLine", icon:()=> h(NIcon, null, ()=> h(Download)) },
        { label:"ÂØºÂá∫ÔºàÊ†ºÂºèÂåñJSONÔºâ", key:"pretty", icon:()=> h(NIcon, null, ()=> h(Download)) }
    ]

    const importForm = reactive({show: false, code:""})
    let menu = ref()
    const attrEditor = reactive({ bean:{}, items:[] })

    let copied = ""
    const onMenuSelect = (key, index, com, container)=>{
        if(key == 'copy'){
            copied = container.copy(index)
            copyText(copied)
            message.success(`Ë°®ÂçïÈ°πÂ∑≤Â§çÂà∂Âà∞Á≤òË¥¥Êùø`)
        }
        else if(key == 'paste'){
            if(!!copied){
                let item = JSON.parse(copied)
                delete item._active
                container.add(item, index)
            }
            else
                message.warning(`ËØ∑ÂÖàÂ§çÂà∂ÂÜçËøõË°åÁ≤òË¥¥`)
        }
        else if(key == 'delete'){
            container.remove(index)
        }
        else {
            container.add(createFormItem(com), index)
        }
    }

    const getItemsByWidget = widget=>{
        for(let g of props.components){
            for(let son of g.items){
                if(son.id == widget)
                    return son.items
            }
        }
    }

    const toActice = item=> {
        if(item._active === true)   return

        let items = getItemsByWidget(item._widget)
        if(!!items){
            if(props.debug) track(`ÁªÑ‰ª∂Ë¢´ÁÇπÂáªÔºö`, item)

            item._active = true
            if(!!attrEditor.bean)  attrEditor.bean._active = false

            attrEditor.bean = item
            attrEditor.items = items
        }
        else
            message.warning(`Ê≥®ÂÜåÁöÑÁªÑ‰ª∂‰∏≠Êâæ‰∏çÂà∞‚åà${item._widget}‚åãÔºåËØ∑ËÅîÁ≥ªÁÆ°ÁêÜÂëò`)
    }

    const toTestSubmit = ()=> dialog.create({
        type:"success",
        title: "Êï∞ÊçÆÊèê‰∫§ÊàêÂäü",
        content: withHtmlNode(props.form.okText||`Êï∞ÊçÆÊèê‰∫§ÂÆåÊàêÔºåÊÑüË∞¢ÊîØÊåÅ`)
    })

    const _error = msg =>{
        message.warning(msg)
        throw Error(msg)
    }

    const _delProperty = (b, field="_active")=>{
        if(b.items){
            b.items.forEach(v=> {
                delete v[field]
                if(v._container===true && v.items)
                    _delProperty(v, field)
            })
        }
    }

    const _toSimpleObject = ()=>{
        if(props.review){
            if(!/^[0-9]+%$|px$/.test(props.form.width))  _error(`Ë°®ÂçïÂÆΩÂ∫¶Â°´ÂÜô‰∏çÂêàÊ≥ï`)

            let items = props.form.items

            let idMap = {}
            let count = 0
            /**
             * Âà§Êñ≠Â≠óÊÆµÂêàÊ≥ïÊÄß
             * @param {Array} targets - Ë°®ÂçïÈ°πÊï∞ÁªÑ
             */
            const _check = (targets, title="", prefix="")=>{
                for (let i = 0; i < targets.length; i++) {
                    const item = targets[i]

                    if("_uuid" in item){
                        count ++
                        if(!item._uuid || ("_text" in item && !item._text))
                            _error(`${title}Á¨¨${count}‰∏™Ë°®ÂçïÈ°πÁöÑÁºñÂè∑Âèä‰∏≠ÊñáÂêç‰∏çËÉΩ‰∏∫Á©∫`)

                        if(item._uuid){
                            let key = prefix? `${prefix}/${item._uuid}`: item._uuid
                            idMap[key] = (idMap[key] || 0) + 1
                        }
                    }

                    if(Array.isArray(item.items)){
                        _check(item.items, `Â≠êË°®Âçï‚åà${item.title}‚åã`, prefix+(!!item._uuid?`/${item._uuid}` : ""))
                    }
                }
            }
            _check(items)

            if(props.debug) track(`Ë°®ÂçïÈ°πIDÂêàÈõÜÔºö`, idMap)
            let repeatId = Object.keys(idMap).filter(v=>idMap[v]>1).join("„ÄÅ")
            if(!!repeatId)  _error(`Â≠òÂú®ÈáçÂ§çË°®ÂçïÈ°πID ‚åà ${repeatId} ‚åã`)
        }

        let form = unref(toRaw(props.form))
        _delProperty(form)

        // Áà∂Á±ªÁªÑ‰ª∂ÊåâÈúÄÂ∞Ü items„ÄÅbuttons ‰∏§‰∏™Êï∞ÁªÑËΩ¨Êç¢‰∏∫ JSON Ê†ºÂºèÁöÑÂ≠óÁ¨¶‰∏≤
        // form.items = JSON.stringify(form.items || "[]")
        // form.buttons = JSON.stringify(form.buttons||"[]")
        return form
    }

    const onFuncSelect = key=>{
        if(key === 'edit'){
            importForm.code = JSON.stringify(_toSimpleObject(), null, 4)
            importForm.show = true
        }
        else if(key === 'import'){
            importForm.code = ""
            importForm.show = true
        }
        else{
            let json = JSON.stringify(_toSimpleObject(), null, type=='pretty'? 4 : undefined)
            if(props.debug) track("Ë°®ÂçïÂØºÂá∫", type, json)
            copyText(json)
            message.success(`Ë°®ÂçïÊï∞ÊçÆÂ∑≤Â§çÂà∂Âà∞Á≤òË¥¥Êùø`)
        }
    }

    const toImport = ()=>{
        if(!importForm.code.trim()) return message.warning(`ËØ∑Â°´ÂÜôJSONÊï∞ÊçÆ`)
        try{
            let bean = JSON.parse(importForm.code)
            Object.assign(props.form, bean)
            nextTick(()=>{
                attrEditor.bean = {}
                importForm.show = false
                importForm.code = ""
            })
        }
        catch(e){
            _error("Ëß£ÊûêJSONÂá∫ÈîôÔºö"+e.message)
        }
    }

    const toSave = ()=>  emits("save", _toSimpleObject())

    // const toPreview = ()=> {
    //     track("È¢ÑËßàË°®Âçï")
    //     message.warning(`Ê≠§ÂäüËÉΩÂºÄÂèë‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖ...`)
    // }

    if(props.enableCtrlS){
        props.debug && track("ÁªëÂÆö CTRL+S ‰øùÂ≠òÂø´Êç∑ÈîÆ")
        document.onkeydown = e => {
            let {ctrlKey, key} = e
            if(ctrlKey==true && key=='s'){
                e.preventDefault()
                toSave()
            }
        }
    }

    if(props.renders){
        props.renders.runScript = (code, formItem)=>{
            if(props.debug) track(`ËÑöÊú¨Ë¢´Ëß¶Âèë`, code, unref(toRaw(formItem)))
            triggerLoaded(code, {}, props.form.items)
        }
    }

    // Êâ©Â±ïË°®ÂçïÈ°πÊï∞ÁªÑÂØπË±°Ôºå‰æø‰∫éÂú®‰∫§‰∫íËÑöÊú¨‰∏≠‰∏éÊ∏≤ÊüìÂô®‰øùÊåÅ‰∏ÄËá¥
    extendFormItems(props.form.items)

    onMounted(()=> {
        let welcome = `Ê¨¢Ëøé‰ΩøÁî® GRID-FROM ËÆæËÆ°Âô®`
        console.group(welcome)
        console.log("ËøôÊòØ‰∏Ä‰∏™%cÂºÄÊ∫êÈ°πÁõÆ", "color:#8c0776;font-weight:bold", "https://github.com/0604hx/grid-form")
        console.log("Â¶ÇÊûúÂØπÊÇ®ÊúâÊâÄÂ∏ÆÂä©ÔºåËØ∑‰∏çÂêùÁÇπ‰∏™Star üòÑ")
        console.groupEnd()
        message.info(welcome)
    })
</script>

<style>
    .w-full {
        width: 100%;
    }
    .designer-content .cell {
        min-height: 50px;
        padding: 8px;
        background: rgba(200, 200, 200, 0.1);
    }
    .designer-content .cell.top {
        background: rgba(200, 200, 200, 0.15);
    }

    .designer-content .flex {
        display: flex;
    }

    .designer-content .cell:hover {
        background: rgba(200, 200, 200, 0.15);
    }

    /* ÊöÇ‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËÆæÁΩÆÂè™ÂØπÁ¨¨‰∏Ä‰∏™ .remove ÁîüÊïàÔºåÊúâÊñπÊ°àÁöÑÂ§ßÁ•ûËØ∑‰∏çÂêùËµêÊïôüòÑ */
    .designer-content .cell.active .remove:nth-of-type(1) {
        display: inline-flex;
    }

    .designer-content .cell .remove {
        display: none;
        position: absolute;
        top: -5px;
        right: -3px;
        z-index: 99;
    }

    .designer-content .cell .n-form-item--top-labelled .remove {
        top: -30px !important;
    }

    .designer-content .cell .n-form-item--no-label .remove {
        top: -5px !important;
    }
</style>
